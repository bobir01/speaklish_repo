# pull official base image
FROM python:3.10-slim

# set work directory
WORKDIR /usr/src/app

# set environment variables
ENV PYTHONDONTWRITEBYTECODE 1
ENV PYTHONUNBUFFERED 1
ENV CRYPTOGRAPHY_DONT_BUILD_RUST=1

# install dependencies
RUN apt-get update \
    && apt-get install -y \
    libffi-dev \
    libpq-dev \
    gcc \
    python3-dev \
    libjpeg-dev \
    zlib1g-dev \
    perl \
    libmagic-dev \
    libpango1.0-dev \
    libopenjp2-7-dev \
    g++ \
    gettext \
    ca-certificates \
    ffmpeg \
    libglib2.0-dev \
    libpoppler-glib-dev \
    poppler-utils \
    xvfb \
    fontconfig \
    build-essential \
    libasound2 \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Install OpenSSL 1.1.1f
RUN wget http://security.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2.22_amd64.deb \
    && dpkg -i libssl1.1_1.1.1f-1ubuntu2.22_amd64.deb \
    && wget http://security.ubuntu.com/ubuntu/pool/main/o/openssl/libssl-dev_1.1.1f-1ubuntu2.22_amd64.deb \
    && dpkg -i libssl-dev_1.1.1f-1ubuntu2.22_amd64.deb

# Cleanup to reduce image size
RUN apt-get clean && rm -rf /var/lib/apt/lists/* \
    && rm *.deb

# install Python dependencies
COPY src/requirements.txt .
RUN pip install --upgrade pip \
    && pip install -r requirements.txt

COPY src/requirements.txt .

# install dependencies
RUN pip install --upgrade pip
RUN pip install -r requirements.txt

# copy project
COPY src/ .


# create directory for the app user
RUN mkdir -p /home/app

# create the app user

# create the appropriate directories
ENV HOME=/home/app
ENV APP_HOME=/home/app/web
RUN mkdir $APP_HOME
RUN mkdir $APP_HOME/static
RUN mkdir $APP_HOME/media
RUN mkdir $APP_HOME/media/{voices,part0,part1,part2,part3}
RUN mkdir $APP_HOME/locale
WORKDIR $APP_HOME

# copy entrypoint.sh
COPY ./entrypoint.sh $APP_HOME

# copy project
COPY src/ $APP_HOME

# VOLUME
#VOLUME /home/app/web/media

RUN chmod -R 755 /home/app/web/media

# chown all the files to the app user
# change to the app user

# run entrypoint.prod.sh
EXPOSE 8321
RUN ["chmod", "+x", "/home/app/web/entrypoint.sh"]
ENTRYPOINT ["/home/app/web/entrypoint.sh"]
